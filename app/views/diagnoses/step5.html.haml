- meta title: t('.title')

#step5-app
  .ui.success.message
    %p= t('.notifications_sent')

  %h1= t('.title')

  %table.ui.table.ui
    %tbody
      - company_name = @diagnosis.visit.facility.company.name_short
      %tr
        %td
          %h2.ui.header
            = company_name
            .sub.header
              = @diagnosis.creation_date_localized
        %td.collapsing
          .ui.middle.aligned.list
            .item
              .middle.aligned.content
                %h4.ui.header.disabled
                  = t('.diagnosed_needs', count: @diagnosis.diagnosed_needs.count)
            .item
              .middle.aligned.content
                %h4.ui.header.disabled
                  -# TODO: Move in Diagnosis helper
                  - selected_assistance_experts_count = @diagnosis.diagnosed_needs.reduce(0) { |sum, diagnosed_need| sum + diagnosed_need.selected_assistance_experts.count }
                  = t('.selected_assistance_experts', count: selected_assistance_experts_count)

  - selected_assistance_experts_count = @diagnosis.diagnosed_needs.reduce(0) { |sum, diagnosed_need| sum + diagnosed_need.selected_assistance_experts.count }

  %h2= t('.company_contact_subtitle')

  - visitee = @diagnosis.visit.visitee
  - visitee_data = [{label: t('activerecord.attributes.contact.last_name'), value: visitee.full_name},
                    {label: t('activerecord.attributes.contact.role'), value: visitee.role},
                    {label: t('activerecord.attributes.contact.email'), value: visitee.email},
                    {label: t('activerecord.attributes.contact.phone_number'), value: visitee.phone_number}]

  .ui.segment.shadow-less
    %table.full-width
      %tbody.small-horizontal-padding
        - (visitee_data.reject { |item| item[:value].blank? }).each do |item|
          %tr
            %td.collapsing
              .small.text.bold= item[:label]
            %td
              .small.text= item[:value]

  %h2= t('.need_contacts_summary_subtitle')
  - @diagnosis.diagnosed_needs.each do |diagnosed_need|
    %table.ui.celled.table
      %thead
        %th= diagnosed_need.question_label
      %tbody
        - if diagnosed_need.content && diagnosed_need.content.lstrip.length > 0
          %tr
            %td
              .ui.form
                .field
                  %label
                    = t('.diagnosis_needs_content_label')
                  = diagnosed_need.content
        - if diagnosed_need.selected_assistance_experts.count > 0
          - diagnosed_need.selected_assistance_experts.each do |selected_assistance_expert|
            %tr
              %td
                = selected_assistance_expert.assistance_expert.expert.full_name
                = ' - '
                = selected_assistance_expert.assistance_expert.expert.institution.name
        - else
          %tr
            %td= t('.zero_contacted_expert')

  %h2= t('.diagnosis_content_subtitle')
  .ui.segment.shadow-less
    .ui.form
      .field
        %label
          = t('.diagnosis_content_label')
        = @diagnosis.content
