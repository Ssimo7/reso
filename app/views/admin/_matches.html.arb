panel "#{I18n.t('active_admin.territories.contacted_experts')} (#{matches_relation.length})" do
  table_for matches_relation
    .includes(diagnosed_need: [diagnosis: [visit: [facility: :company]]])
    .includes(diagnosed_need: [diagnosis: [visit: :advisor]])
    .includes(:expert)
    .order(created_at: :desc) do
    column(:id) do |match|
      link_to(match.id, admin_match_path(match))
    end
    column :created_at
    column(I18n.t('activerecord.attributes.visit.advisor')) do |match|
      advisor = match.diagnosed_need.diagnosis.visit.advisor
      link_to(advisor.full_name_with_role, admin_user_path(advisor))
    end
    column(I18n.t('activerecord.attributes.visit.facility')) do |match|
      match.diagnosed_need&.diagnosis&.visit&.facility
    end
    column(:diagnosed_need) do |match|
      need = match.diagnosed_need
      link_to(need.id, admin_diagnosed_need_path(need)) + " (#{need.question_label})".html_safe
    end
    column :expert_full_name do |match|
      expert = match.expert
      if expert.present?
        link_to(match.expert_description, admin_expert_path(expert))
      else
        link_to(match.expert_description, admin_relay_path(match.relay))
      end
    end
    column :status do |match|
      I18n.t("activerecord.attributes.match.statuses.#{match.status}")
    end
    column('Page Référent') do |match|
      diagnosis_id = match.diagnosed_need.diagnosis_id
      if match.assistance_expert
        access_token = match.assistance_expert.expert.access_token
        link_to 'Page Référent', diagnosis_experts_path(diagnosis_id: diagnosis_id, access_token: access_token)
      else
        link_to 'Page Référent', diagnosis_relays_path(diagnosis_id: diagnosis_id, relay_id: match.relay_id)
      end
    end
  end
end
